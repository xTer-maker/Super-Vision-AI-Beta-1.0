<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Vision AI 1.0</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Thi·∫øt l·∫≠p Font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom CSS cho giao di·ªán mobile */
        .container-wrapper {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Start from the top on mobile */
            align-items: center;
            background-color: #0d1117;
            color: #c9d1d9;
            padding: 1rem;
        }
        .main-card {
            background-color: #161b22;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6);
            max-width: 420px; /* Gi·ªõi h·∫°n ph√π h·ª£p v·ªõi ƒëi·ªán tho·∫°i */
            width: 100%;
            margin-top: 1rem;
        }
        .action-button {
            transition: all 0.2s;
            /* TƒÉng k√≠ch th∆∞·ªõc n√∫t cho d·ªÖ ch·∫°m tr√™n di ƒë·ªông */
            min-height: 56px; 
            font-size: 1.125rem; /* text-lg */
        }
        .action-button:hover, .action-button:active {
            transform: scale(0.98); /* Hi·ªáu ·ª©ng ch·∫°m */
            box-shadow: 0 1px 3px rgba(66, 153, 225, 0.6);
        }
        /* ·∫®n ph·∫ßn t·ª≠ kh√¥ng c·∫ßn thi·∫øt */
        #screen-video, #screen-canvas {
            display: none;
        }
        .loading-animation {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-inter">

    <div class="container-wrapper">
        <div class="main-card p-4 rounded-xl border border-gray-700">
            <h1 class="text-2xl font-extrabold mb-3 text-blue-400 text-center">ü§ñ Tr·ª£ L√Ω Vision Mobile</h1>
            <p id="status-message" class="text-sm text-gray-500 mb-4 text-center">ƒêang kh·ªüi t·∫°o...</p>
            
            <!-- Ph·∫ßn ƒëi·ªÅu khi·ªÉn -->
            <div class="flex flex-col space-y-4 mb-6">
                <button id="start-btn" onclick="startCapture()" 
                        class="action-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    B·∫ÆT ƒê·∫¶U CHIA S·∫∫ M√ÄN H√åNH
                </button>
                <button id="stop-btn" onclick="stopCapture()" disabled
                        class="action-button bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    D·ª™NG CHIA S·∫∫
                </button>
            </div>
            
            <div class="mb-4 p-3 bg-gray-800 rounded-lg text-sm border border-gray-700">
                <p class="text-gray-400 font-medium mb-1">üí° L∆∞u √Ω quan tr·ªçng tr√™n Mobile:</p>
                <ul class="list-disc list-inside ml-2 text-gray-500 space-y-1">
                    <li>B·∫°n ph·∫£i ch·ªçn "To√†n b·ªô m√†n h√¨nh" (ho·∫∑c tab/·ª©ng d·ª•ng) ƒë·ªÉ AI c√≥ th·ªÉ "th·∫•y".</li>
                    <li>AI qu√©t m√†n h√¨nh m·ªói 2 gi√¢y ƒë·ªÉ t√¨m v√† tr·∫£ l·ªùi c√¢u h·ªèi.</li>
                </ul>
            </div>

            <!-- Khu v·ª±c Hi·ªÉn th·ªã K·∫øt qu·∫£ AI -->
            <div class="mt-6">
                <h2 class="text-xl font-semibold mb-3 text-white flex items-center">
                    <span id="ai-status-icon" class="mr-2 text-yellow-400">üëÄ</span>
                    ƒê√°p √Ån T·ª± ƒê·ªông C·ªßa AI
                </h2>
                <div id="loading-indicator" class="hidden flex items-center text-blue-400 mb-2">
                    <div class="loading-animation mr-2"></div>
                    ƒêang qu√©t v√† ch·ªù ph·∫£n h·ªìi AI...
                </div>
                <div id="ai-response-display" class="p-4 bg-gray-700 rounded-xl border-l-4 border-blue-500 min-h-[120px] text-sm whitespace-pre-wrap">
                    <p class="text-gray-400 italic">K·∫øt qu·∫£ gi·∫£i th√≠ch/tr·∫£ l·ªùi s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y. H√£y m·ªü c·ª≠a s·ªï c√≥ c√¢u h·ªèi sau khi nh·∫•n B·∫ÆT ƒê·∫¶U.</p>
                </div>
                <p id="last-processed" class="text-xs text-gray-500 mt-2 text-right">L·∫ßn x·ª≠ l√Ω g·∫ßn nh·∫•t: Ch∆∞a c√≥</p>
            </div>
            
            <!-- Ph·∫ßn t·ª≠ ·∫©n ƒë·ªÉ x·ª≠ l√Ω video/h√¨nh ·∫£nh -->
            <video id="screen-video" autoplay></video>
            <canvas id="screen-canvas"></canvas>
        </div>
    </div>

    <script type="module">
        // Kh·ªüi t·∫°o c√°c bi·∫øn to√†n c·ª•c cho Firebase (MANDATORY)
        window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        window.__app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.__initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db, auth;
        let userId;

        // --- Kh·ªüi t·∫°o v√† X√°c th·ª±c Firebase ---
        if (Object.keys(window.firebaseConfig).length > 0) {
            const app = initializeApp(window.firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');

            const authenticate = async () => {
                try {
                    if (window.__initial_auth_token) {
                        await signInWithCustomToken(auth, window.__initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    document.getElementById('status-message').textContent = 'L·ªói x√°c th·ª±c Firebase: ' + error.message;
                }
            };

            authenticate();

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('status-message').textContent = `‚úÖ ƒê√£ k·∫øt n·ªëi. User ID: ${userId}`;
                } else {
                    userId = crypto.randomUUID(); 
                }
            });
        } else {
            document.getElementById('status-message').textContent = '‚ö†Ô∏è C·∫£nh b√°o: Kh√¥ng c√≥ c·∫•u h√¨nh Firebase. Ch·ªâ ch·∫°y t√≠nh nƒÉng AI.';
        }
        
        // --- Logic X·ª≠ l√Ω Vision AI ---
        const apiKey = ""; // API key s·∫Ω ƒë∆∞·ª£c cung c·∫•p t·ª± ƒë·ªông
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        let mediaStream = null;
        let captureInterval = null;
        let isProcessing = false;
        const CAPTURE_INTERVAL_MS = 2000; // Ch·ª•p ·∫£nh m·ªói 2 gi√¢y

        const video = document.getElementById('screen-video');
        const canvas = document.getElementById('screen-canvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const responseDisplay = document.getElementById('ai-response-display');
        const loadingIndicator = document.getElementById('loading-indicator');
        const lastProcessedText = document.getElementById('last-processed');
        const statusIcon = document.getElementById('ai-status-icon');

        /**
         * B·∫Øt ƒë·∫ßu qu√° tr√¨nh chia s·∫ª m√†n h√¨nh.
         * Tr√™n di ƒë·ªông, API n√†y s·∫Ω y√™u c·∫ßu ng∆∞·ªùi d√πng ch·ªçn to√†n b·ªô m√†n h√¨nh/·ª©ng d·ª•ng.
         */
        window.startCapture = async function() {
            try {
                // Y√™u c·∫ßu quy·ªÅn truy c·∫≠p m√†n h√¨nh/c·ª≠a s·ªï/tab
                mediaStream = await navigator.mediaDevices.getDisplayMedia({
                    video: true
                });

                if (mediaStream) {
                    video.srcObject = mediaStream;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    responseDisplay.innerHTML = '<p class="text-gray-400 italic">ƒê√£ b·∫Øt ƒë·∫ßu chia s·∫ª. ƒêang ch·ªù AI qu√©t m√†n h√¨nh...</p>';
                    statusIcon.textContent = 'üü¢';
                    
                    // Thi·∫øt l·∫≠p k√≠ch th∆∞·ªõc canvas d·ª±a tr√™n lu·ªìng video
                    video.onloadedmetadata = () => {
                        // T·ªëi ∆∞u h√≥a: Gi·∫£m k√≠ch th∆∞·ªõc khung h√¨nh n·∫øu c·∫ßn thi·∫øt cho mobile
                        const MAX_SIZE = 1280;
                        let ratio = video.videoWidth / video.videoHeight;
                        
                        if (video.videoWidth > MAX_SIZE || video.videoHeight > MAX_SIZE) {
                            if (video.videoWidth > video.videoHeight) {
                                canvas.width = MAX_SIZE;
                                canvas.height = MAX_SIZE / ratio;
                            } else {
                                canvas.height = MAX_SIZE;
                                canvas.width = MAX_SIZE * ratio;
                            }
                        } else {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                        }

                        // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p ch·ª•p v√† x·ª≠ l√Ω
                        captureInterval = setInterval(captureAndProcess, CAPTURE_INTERVAL_MS);
                    };
                }
            } catch (err) {
                console.error("L·ªói khi b·∫Øt ƒë·∫ßu chia s·∫ª tr√™n mobile:", err);
                responseDisplay.innerHTML = `<p class="text-red-400">L·ªói khi b·∫Øt ƒë·∫ßu chia s·∫ª: ${err.name}. Vui l√≤ng c·∫•p quy·ªÅn v√† th·ª≠ l·∫°i.</p>`;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                statusIcon.textContent = '‚ùå';
            }
        }

        /**
         * D·ª´ng qu√° tr√¨nh chia s·∫ª.
         */
        window.stopCapture = function() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }
            isProcessing = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            loadingIndicator.classList.add('hidden');
            responseDisplay.innerHTML = '<p class="text-gray-400 italic">ƒê√£ d·ª´ng chia s·∫ª. Nh·∫•n "B·∫ÆT ƒê·∫¶U" ƒë·ªÉ ti·∫øp t·ª•c.</p>';
            statusIcon.textContent = 'üëÄ';
        }

        /**
         * Ch·ª•p m·ªôt khung h√¨nh t·ª´ video v√† g·ªçi API Gemini.
         */
        async function captureAndProcess() {
            if (isProcessing) {
                console.log("B·ªè qua khung h√¨nh: Y√™u c·∫ßu tr∆∞·ªõc ƒë√≥ ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω.");
                return;
            }

            if (video.readyState < video.HAVE_CURRENT_DATA) {
                console.log("Video ch∆∞a s·∫µn s√†ng d·ªØ li·ªáu.");
                return;
            }

            isProcessing = true;
            loadingIndicator.classList.remove('hidden');
            statusIcon.textContent = 'üîÑ';

            try {
                // 1. V·∫Ω khung h√¨nh video l√™n canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // 2. Chuy·ªÉn canvas sang Base64 data URL (Gi·ªØ ch·∫•t l∆∞·ª£ng 0.8 ƒë·ªÉ t·ªëi ∆∞u mobile)
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8); 
                const base64Data = dataUrl.split(',')[1];
                
                // 3. G·ªçi API Gemini
                const result = await callGeminiVisionAPI(base64Data);
                
                const now = new Date().toLocaleTimeString('vi-VN');
                lastProcessedText.textContent = `L·∫ßn x·ª≠ l√Ω g·∫ßn nh·∫•t: ${now}`;

                // 4. C·∫≠p nh·∫≠t giao di·ªán
                if (result && result.trim() !== 'NO_QUESTION') {
                    // C·∫≠p nh·∫≠t c√¢u tr·∫£ l·ªùi m·ªõi
                    responseDisplay.innerHTML = `<span class="font-bold text-blue-300">AI TR·∫¢ L·ªúI T·ª∞ ƒê·ªòNG:</span><br>${result}`;
                } else {
                    // N·∫øu kh√¥ng c√≥ c√¢u h·ªèi, kh√¥ng l√†m g√¨ ƒë·ªÉ tr√°nh l√†m m·ªõi h·ªôp tho·∫°i
                    console.log('Kh√¥ng ph√°t hi·ªán c√¢u h·ªèi trong khung h√¨nh.');
                }
                statusIcon.textContent = 'üü¢';

            } catch (error) {
                console.error("L·ªói trong qu√° tr√¨nh ch·ª•p ho·∫∑c g·ªçi AI:", error);
                responseDisplay.innerHTML = `<p class="text-red-400">L·ªói x·ª≠ l√Ω AI: ${error.message}. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi m·∫°ng.</p>`;
                statusIcon.textContent = '‚ö†Ô∏è';
                // D·ª´ng t·ª± ƒë·ªông n·∫øu c√≥ l·ªói n·∫∑ng
                if (error.message.includes('HTTP error!')) {
                     // D·ª´ng h·∫≥n n·∫øu l·ªói API
                    stopCapture();
                }
            } finally {
                isProcessing = false;
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * G·ª≠i h√¨nh ·∫£nh v√† prompt ƒë·∫øn API Gemini.
         */
        async function callGeminiVisionAPI(base64ImageData) {
            const systemPrompt = "B·∫°n l√† m·ªôt tr·ª£ l√Ω AI th√¥ng minh, ho·∫°t ƒë·ªông t·ª± ƒë·ªông v√† kh√¥ng l·ªùi. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ph√¢n t√≠ch h√¨nh ·∫£nh m√†n h√¨nh. N·∫øu b·∫°n ph√°t hi·ªán b·∫•t k·ª≥ c√¢u h·ªèi, thu·∫≠t ng·ªØ k·ªπ thu·∫≠t, ho·∫∑c kh√°i ni·ªám n√†o c·∫ßn gi·∫£i th√≠ch trong h√¨nh ·∫£nh, h√£y cung c·∫•p m·ªôt c√¢u tr·∫£ l·ªùi ho·∫∑c gi·∫£i th√≠ch NG·∫ÆN G·ªåN, TR·ª∞C TI·∫æP v√† b·∫±ng TI·∫æNG VI·ªÜT. N·∫øu kh√¥ng t√¨m th·∫•y b·∫•t k·ª≥ c√¢u h·ªèi ho·∫∑c kh√°i ni·ªám ƒë√°ng ch√∫ √Ω n√†o, b·∫°n PH·∫¢I ch·ªâ tr·∫£ l·ªùi DUY NH·∫§T m·ªôt chu·ªói k√Ω t·ª± 'NO_QUESTION'.";
            const userQuery = "Ph√¢n t√≠ch n·ªôi dung m√†n h√¨nh n√†y v√† t·ª± ƒë·ªông tr·∫£ l·ªùi b·∫•t k·ª≥ c√¢u h·ªèi n√†o ƒë∆∞·ª£c hi·ªÉn th·ªã ho·∫∑c gi·∫£i th√≠ch c√°c kh√°i ni·ªám quan tr·ªçng.";

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userQuery },
                            {
                                inlineData: {
                                    mimeType: "image/jpeg",
                                    data: base64ImageData
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            // C∆° ch·∫ø Retry (L·∫∑p l·∫°i) v·ªõi Backoff
            const MAX_RETRIES = 3;
            let lastError = null;

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`HTTP error! status: ${response.status} - ${JSON.stringify(errorBody)}`);
                    }

                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    return text.trim();

                } catch (error) {
                    lastError = error;
                    console.warn(`Th·ª≠ l·∫°i l·∫ßn ${i + 1} th·∫•t b·∫°i. ƒêang ƒë·ª£i ${Math.pow(2, i)} gi√¢y...`, error);
                    if (i < MAX_RETRIES - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                }
            }
            throw new Error(`L·ªói API Vision sau ${MAX_RETRIES} l·∫ßn th·ª≠. L·ªói cu·ªëi: ${lastError?.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}`);
        }
        
        // Nghe s·ª± ki·ªán khi ng∆∞·ªùi d√πng d·ª´ng chia s·∫ª qua n√∫t tr√¨nh duy·ªát
        if (video) {
            video.addEventListener('ended', window.stopCapture);
        }

    </script>
</body>
</html>

