<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Vision AI Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Th∆∞ vi·ªán Firebase cho Firestore v√† Authentication -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Khai b√°o bi·∫øn to√†n c·ª•c (s·∫Ω ƒë∆∞·ª£c g√°n trong window)
        window.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        window.__app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.__initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

        if (Object.keys(window.firebaseConfig).length > 0) {
            window.app = initializeApp(window.firebaseConfig);
            window.db = getFirestore(window.app);
            window.auth = getAuth(window.app);
            setLogLevel('Debug');

            // H√†m x√°c th·ª±c
            const authenticate = async () => {
                try {
                    if (window.__initial_auth_token) {
                        await signInWithCustomToken(window.auth, window.__initial_auth_token);
                    } else {
                        await signInAnonymously(window.auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    document.getElementById('status-message').textContent = 'L·ªói x√°c th·ª±c Firebase: ' + error.message;
                }
            };

            // ƒêƒÉng nh·∫≠p ngay khi ·ª©ng d·ª•ng t·∫£i
            authenticate();

            // L·∫Øng nghe tr·∫°ng th√°i x√°c th·ª±c ƒë·ªÉ l·∫•y userId
            onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    window.userId = user.uid;
                    document.getElementById('status-message').textContent = `ƒê√£ k·∫øt n·ªëi. User ID: ${window.userId}`;
                } else {
                    window.userId = crypto.randomUUID(); // D√πng ID ng·∫´u nhi√™n n·∫øu ·∫©n danh
                }
            });
        } else {
            document.getElementById('status-message').textContent = 'C·∫£nh b√°o: Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh Firebase. ·ª®ng d·ª•ng s·∫Ω ch·∫°y ·ªü ch·∫ø ƒë·ªô m√¥ ph·ªèng.';
        }
    </script>
    <style>
        /* Custom CSS cho giao di·ªán */
        .container-wrapper {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #0d1117;
            color: #c9d1d9;
            padding: 1rem;
        }
        .main-card {
            background-color: #161b22;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            max-width: 600px;
            width: 100%;
        }
        .action-button {
            transition: all 0.2s;
        }
        .action-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.6);
        }
        /* ·∫®n ph·∫ßn t·ª≠ kh√¥ng c·∫ßn thi·∫øt tr√™n giao di·ªán */
        #screen-video, #screen-canvas {
            display: none;
        }
        .loading-animation {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans">

    <div class="container-wrapper">
        <div class="main-card p-6 rounded-xl border border-gray-700">
            <h1 class="text-3xl font-bold mb-4 text-blue-400 text-center">ü§ñ Tr·ª£ L√Ω T·ª± ƒê·ªông Vision AI</h1>
            <p id="status-message" class="text-sm text-gray-500 mb-4 text-center">ƒêang kh·ªüi t·∫°o...</p>
            
            <!-- Ph·∫ßn ƒëi·ªÅu khi·ªÉn -->
            <div class="flex flex-col space-y-3 mb-6">
                <button id="start-btn" onclick="startCapture()" 
                        class="action-button bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    B·∫Øt ƒê·∫ßu Chia S·∫ª M√†n H√¨nh
                </button>
                <button id="stop-btn" onclick="stopCapture()" disabled
                        class="action-button bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    D·ª´ng Chia S·∫ª
                </button>
            </div>
            
            <div class="mb-4 p-4 bg-gray-800 rounded-lg text-sm border border-gray-700">
                <p class="text-gray-400 font-medium">H∆∞·ªõng d·∫´n:</p>
                <ol class="list-decimal list-inside ml-2 text-gray-500">
                    <li>Nh·∫•n "B·∫Øt ƒê·∫ßu" v√† ch·ªçn c·ª≠a s·ªï/tab b·∫°n mu·ªën AI ph√¢n t√≠ch.</li>
                    <li>·ª®ng d·ª•ng s·∫Ω ch·ª•p ·∫£nh m√†n h√¨nh ƒë√≥ m·ªói 2 gi√¢y.</li>
                    <li>AI s·∫Ω t·ª± ƒë·ªông t√¨m v√† tr·∫£ l·ªùi b·∫•t k·ª≥ c√¢u h·ªèi n√†o n√≥ nh√¨n th·∫•y.</li>
                </ol>
            </div>

            <!-- Khu v·ª±c Hi·ªÉn th·ªã K·∫øt qu·∫£ AI -->
            <div class="mt-6">
                <h2 class="text-xl font-semibold mb-3 text-white flex items-center">
                    <span id="ai-status-icon" class="mr-2 text-yellow-400">üëÄ</span>
                    ƒê√°p √Ån T·ª± ƒê·ªông
                </h2>
                <div id="loading-indicator" class="hidden flex items-center text-blue-400 mb-2">
                    <div class="loading-animation mr-2"></div>
                    ƒêang g·ª≠i ·∫£nh v√† ch·ªù ph·∫£n h·ªìi AI...
                </div>
                <div id="ai-response-display" class="p-4 bg-gray-700 rounded-lg border-l-4 border-blue-500 min-h-[100px] whitespace-pre-wrap">
                    <p class="text-gray-400 italic">K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y khi AI ph√°t hi·ªán c√¢u h·ªèi.</p>
                </div>
                <p id="last-processed" class="text-xs text-gray-500 mt-2 text-right">L·∫ßn x·ª≠ l√Ω g·∫ßn nh·∫•t: Ch∆∞a c√≥</p>
            </div>
            
            <!-- Ph·∫ßn t·ª≠ ·∫©n ƒë·ªÉ x·ª≠ l√Ω video/h√¨nh ·∫£nh -->
            <video id="screen-video" autoplay></video>
            <canvas id="screen-canvas"></canvas>
        </div>
    </div>

    <script type="module">
        const apiKey = ""; // API key s·∫Ω ƒë∆∞·ª£c cung c·∫•p t·ª± ƒë·ªông b·ªüi Canvas
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        let mediaStream = null;
        let captureInterval = null;
        let isProcessing = false;
        const CAPTURE_INTERVAL_MS = 2000; // Ch·ª•p ·∫£nh m·ªói 2 gi√¢y

        const video = document.getElementById('screen-video');
        const canvas = document.getElementById('screen-canvas');
        const ctx = canvas.getContext('2d');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const responseDisplay = document.getElementById('ai-response-display');
        const loadingIndicator = document.getElementById('loading-indicator');
        const lastProcessedText = document.getElementById('last-processed');
        const statusIcon = document.getElementById('ai-status-icon');

        /**
         * @function startCapture
         * B·∫Øt ƒë·∫ßu qu√° tr√¨nh chia s·∫ª v√† x·ª≠ l√Ω m√†n h√¨nh.
         */
        window.startCapture = async function() {
            try {
                // Y√™u c·∫ßu quy·ªÅn truy c·∫≠p m√†n h√¨nh/c·ª≠a s·ªï/tab
                mediaStream = await navigator.mediaDevices.getDisplayMedia({
                    video: true
                });

                if (mediaStream) {
                    video.srcObject = mediaStream;
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    responseDisplay.innerHTML = '<p class="text-gray-400 italic">ƒê√£ b·∫Øt ƒë·∫ßu chia s·∫ª. ƒêang ch·ªù AI qu√©t m√†n h√¨nh...</p>';
                    statusIcon.textContent = 'üü¢';
                    
                    // Thi·∫øt l·∫≠p k√≠ch th∆∞·ªõc canvas d·ª±a tr√™n lu·ªìng video
                    video.onloadedmetadata = () => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        // B·∫Øt ƒë·∫ßu v√≤ng l·∫∑p ch·ª•p v√† x·ª≠ l√Ω
                        captureInterval = setInterval(captureAndProcess, CAPTURE_INTERVAL_MS);
                    };
                }
            } catch (err) {
                console.error("Error starting media capture:", err);
                responseDisplay.innerHTML = `<p class="text-red-400">L·ªói khi b·∫Øt ƒë·∫ßu chia s·∫ª: ${err.name}. Vui l√≤ng c·∫•p quy·ªÅn ho·∫∑c th·ª≠ l·∫°i.</p>`;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                statusIcon.textContent = '‚ùå';
            }
        }

        /**
         * @function stopCapture
         * D·ª´ng qu√° tr√¨nh chia s·∫ª v√† x·ª≠ l√Ω m√†n h√¨nh.
         */
        window.stopCapture = function() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            if (captureInterval) {
                clearInterval(captureInterval);
                captureInterval = null;
            }
            isProcessing = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            loadingIndicator.classList.add('hidden');
            responseDisplay.innerHTML = '<p class="text-gray-400 italic">ƒê√£ d·ª´ng chia s·∫ª. Nh·∫•n "B·∫Øt ƒê·∫ßu" ƒë·ªÉ ti·∫øp t·ª•c.</p>';
            statusIcon.textContent = 'üëÄ';
        }

        /**
         * @function captureAndProcess
         * Ch·ª•p m·ªôt khung h√¨nh t·ª´ video, chuy·ªÉn th√†nh Base64 v√† g·ªçi API Gemini.
         */
        async function captureAndProcess() {
            if (isProcessing) {
                // B·ªè qua n·∫øu khung h√¨nh tr∆∞·ªõc ƒë√≥ v·∫´n ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω
                console.log("Skipping frame: previous request is still pending.");
                return;
            }

            if (video.readyState < video.HAVE_CURRENT_DATA) {
                 // ƒê·∫£m b·∫£o video ƒë√£ c√≥ d·ªØ li·ªáu ƒë·ªÉ v·∫Ω
                console.log("Video not ready yet.");
                return;
            }

            isProcessing = true;
            loadingIndicator.classList.remove('hidden');
            statusIcon.textContent = 'üîÑ';

            try {
                // 1. V·∫Ω khung h√¨nh video l√™n canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // 2. Chuy·ªÉn canvas sang Base64 data URL
                const dataUrl = canvas.toDataURL('image/jpeg', 0.8); // D√πng JPEG ƒë·ªÉ gi·∫£m k√≠ch th∆∞·ªõc
                const base64Data = dataUrl.split(',')[1];
                
                // 3. G·ªçi API Gemini
                const result = await callGeminiVisionAPI(base64Data);
                
                const now = new Date().toLocaleTimeString('vi-VN');
                lastProcessedText.textContent = `L·∫ßn x·ª≠ l√Ω g·∫ßn nh·∫•t: ${now}`;

                // 4. C·∫≠p nh·∫≠t giao di·ªán
                if (result && result.trim() !== 'NO_QUESTION') {
                    responseDisplay.innerHTML = `<span class="font-bold text-blue-300">AI DETECTED & ANSWERED:</span><br>${result}`;
                } else {
                    // N·∫øu kh√¥ng c√≥ c√¢u h·ªèi, gi·ªØ nguy√™n ƒë√°p √°n c≈© nh∆∞ng th√¥ng b√°o qu√©t th√†nh c√¥ng
                    responseDisplay.innerHTML += ''; // Kh√¥ng l√†m g√¨ n·∫øu kh√¥ng c√≥ c√¢u h·ªèi m·ªõi
                }
                statusIcon.textContent = 'üü¢';

            } catch (error) {
                console.error("Error during capture or AI call:", error);
                responseDisplay.innerHTML = `<p class="text-red-400">L·ªói x·ª≠ l√Ω AI: ${error.message}</p>`;
                statusIcon.textContent = '‚ö†Ô∏è';
            } finally {
                isProcessing = false;
                loadingIndicator.classList.add('hidden');
            }
        }

        /**
         * @function callGeminiVisionAPI
         * G·ª≠i h√¨nh ·∫£nh v√† prompt ƒë·∫øn API Gemini.
         * @param {string} base64ImageData - D·ªØ li·ªáu h√¨nh ·∫£nh Base64.
         * @returns {Promise<string>} - VƒÉn b·∫£n ph·∫£n h·ªìi t·ª´ AI.
         */
        async function callGeminiVisionAPI(base64ImageData) {
            const systemPrompt = "B·∫°n l√† m·ªôt tr·ª£ l√Ω AI th√¥ng minh, ho·∫°t ƒë·ªông t·ª± ƒë·ªông v√† kh√¥ng l·ªùi. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ph√¢n t√≠ch h√¨nh ·∫£nh m√†n h√¨nh. N·∫øu b·∫°n ph√°t hi·ªán b·∫•t k·ª≥ c√¢u h·ªèi, thu·∫≠t ng·ªØ k·ªπ thu·∫≠t, ho·∫∑c kh√°i ni·ªám n√†o c·∫ßn gi·∫£i th√≠ch trong h√¨nh ·∫£nh, h√£y cung c·∫•p m·ªôt c√¢u tr·∫£ l·ªùi ho·∫∑c gi·∫£i th√≠ch NG·∫ÆN G·ªåN, TR·ª∞C TI·∫æP v√† b·∫±ng TI·∫æNG VI·ªÜT. N·∫øu kh√¥ng t√¨m th·∫•y b·∫•t k·ª≥ c√¢u h·ªèi ho·∫∑c kh√°i ni·ªám ƒë√°ng ch√∫ √Ω n√†o, b·∫°n PH·∫¢I ch·ªâ tr·∫£ l·ªùi DUY NH·∫§T m·ªôt chu·ªói k√Ω t·ª± 'NO_QUESTION'.";
            const userQuery = "Ph√¢n t√≠ch n·ªôi dung m√†n h√¨nh n√†y v√† t·ª± ƒë·ªông tr·∫£ l·ªùi b·∫•t k·ª≥ c√¢u h·ªèi n√†o ƒë∆∞·ª£c hi·ªÉn th·ªã ho·∫∑c gi·∫£i th√≠ch c√°c kh√°i ni·ªám quan tr·ªçng.";

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userQuery },
                            {
                                inlineData: {
                                    mimeType: "image/jpeg",
                                    data: base64ImageData
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            // S·ª≠ d·ª•ng c∆° ch·∫ø Retry (L·∫∑p l·∫°i) v·ªõi Backoff ƒë·ªÉ x·ª≠ l√Ω l·ªói m·∫°ng/API t·∫°m th·ªùi
            const MAX_RETRIES = 3;
            let lastError = null;

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`HTTP error! status: ${response.status} - ${JSON.stringify(errorBody)}`);
                    }

                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    return text.trim();

                } catch (error) {
                    lastError = error;
                    console.warn(`Attempt ${i + 1} failed. Retrying in ${Math.pow(2, i)} seconds...`, error);
                    if (i < MAX_RETRIES - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                }
            }

            // N·∫øu t·∫•t c·∫£ c√°c l·∫ßn th·ª≠ ƒë·ªÅu th·∫•t b·∫°i
            throw new Error(`API call failed after ${MAX_RETRIES} attempts. Last error: ${lastError?.message || 'Unknown error'}`);
        }
        
        // Nghe s·ª± ki·ªán khi ng∆∞·ªùi d√πng d·ª´ng chia s·∫ª qua n√∫t tr√¨nh duy·ªát
        if (video) {
            video.addEventListener('ended', stopCapture);
        }

    </script>
</body>
</html>
